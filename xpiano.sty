\ProvidesPackage{xpiano}[2015/05/21 from piano.sty by Ã‰mile Daneault]
\RequirePackage{xcolor}
\RequirePackage{xparse}

\definecolor{pianodefault}{RGB}{72,118,255}

\ExplSyntaxOn
\NewDocumentCommand{\keyboard}{ m }
 {
  \piano_keyboard:n { #1 }
 }
\NewDocumentCommand{\keyboardsetup}{ m }
 {
  \keys_set:nn { piano } { #1 }
 }

\keys_define:nn { piano }
 {
  font    .tl_set:N   = \l_piano_fontsize_tl,
  single  .bool_set:N = \l_piano_single_bool,
  ext     .bool_set:N = \l_piano_ext_bool,
  size    .dim_set:N  = \l_piano_size_dim,
  height  .tl_set:N   = \l_piano_height_tl,
  numbers .bool_set:N = \l_piano_numbers_bool,
  color   .tl_set:N   = \l_piano_color_tl,
  one     .tl_set:N   = \l_piano_one_tl,
  two     .tl_set:N   = \l_piano_two_tl,
  three   .tl_set:N   = \l_piano_three_tl,
  four    .tl_set:N   = \l_piano_four_tl,
  five    .tl_set:N   = \l_piano_five_tl,
  six     .tl_set:N   = \l_piano_six_tl,
  seven   .tl_set:N   = \l_piano_seven_tl,
  eight   .tl_set:N   = \l_piano_eight_tl,
  font    .initial:n  = \footnotesize,
  single  .initial:n  = true,
  single  .default:n  = true,
  ext     .initial:n  = false,
  ext     .default:n  = false,
  size    .initial:n  = 0.63cm,
  height  .initial:n  = 3.5,
  numbers .initial:n  = true,
  numbers .default:n  = true,
  color   .initial:n  = {pianodefault},
  one     .initial:n  = {},
  two     .initial:n  = {},
  three   .initial:n  = {},
  four    .initial:n  = {},
  five    .initial:n  = {},
  six     .initial:n  = {},
  seven   .initial:n  = {},
  eight   .initial:n  = {},
 }

\tl_new:N \l__piano_width_tl

\cs_new_protected:Npn \piano_keyboard:n #1
 {
  \group_begin:
  \keys_set:nn { piano } { #1 }
  \bool_if:NTF \l_piano_ext_bool
   {
    \tl_set:Nx \l__piano_width_tl
     {
      \bool_if:NTF \l_piano_single_bool { 8 } { 15 }
     }
   }
   {
    \tl_set:Nx \l__piano_width_tl
     {
      \bool_if:NTF \l_piano_single_bool { 7 } { 14 }
     }
   }

  %% Clavier 2 octaves
  \setlength{\unitlength}{\l_piano_size_dim}
  \begin{picture}(\l__piano_width_tl,\l_piano_height_tl)
  %Touches blanches
  \multiput(0,0)(1,0){\l__piano_width_tl}{\line(0,1){\l_piano_height_tl}}

  %Contour
  \put(0,0){\line(0,1){\l_piano_height_tl}}
  \put(0,0){\line(1,0){\l__piano_width_tl}}
  \put(\l__piano_width_tl,0){\line(0,1){\l_piano_height_tl}}
  \put(0,\l_piano_height_tl){\line(1,0){\l__piano_width_tl}}

  %Touches noires
  \linethickness{.6\l_piano_size_dim}
  \multiput(1,\l_piano_height_tl)(1,0){2}{\line(0,-1){\fp_eval:n {0.67*\l_piano_height_tl}}}
  \multiput(4,\l_piano_height_tl)(1,0){3}{\line(0,-1){\fp_eval:n {0.67*\l_piano_height_tl}}}
  \bool_if:NF \l_piano_single_bool
   {
    \multiput(8,\l_piano_height_tl)(1,0){2}{\line(0,-1){\fp_eval:n {0.67*\l_piano_height_tl}}}
    \multiput(11,\l_piano_height_tl)(1,0){3}{\line(0,-1){\fp_eval:n {0.67*\l_piano_height_tl}}}
   }
  %Rond de note
  \color{\l_piano_color_tl}
  \__piano_do_key:N \l_piano_one_tl
  \__piano_do_key:N \l_piano_two_tl
  \__piano_do_key:N \l_piano_three_tl
  \__piano_do_key:N \l_piano_four_tl
  \__piano_do_key:N \l_piano_five_tl
  \__piano_do_key:N \l_piano_six_tl
  \__piano_do_key:N \l_piano_seven_tl
  \__piano_do_key:N \l_piano_eight_tl

  \end{picture}
  \group_end:
 }

\cs_new_protected:Npn \__piano_add_note:nn #1 #2
 {
  \put(#2){\circle*{0.5}}
  \bool_if:NT \l_piano_numbers_bool
   {
    \put(#2){\makebox(0,0){\color{black}\l_piano_fontsize_tl #1}}
   }
 }

\cs_new_protected:Npn \__piano_do_key:N #1
 {
  \str_case:Vn #1
   {
    {}{}% initial case
    {C}{\__piano_add_note:nn {0}{0.5,0.5}}
    {D}{\__piano_add_note:nn {2}{1.5,0.5}}
    {E}{\__piano_add_note:nn {4}{2.5,0.5}}
    {F}{\__piano_add_note:nn {5}{3.5,0.5}}
    {G}{\__piano_add_note:nn {7}{4.5,0.5}}
    {A}{\__piano_add_note:nn {9}{5.5,0.5}}
    {B}{\__piano_add_note:nn {$e$}{6.5,0.5}}
    {C1}{\__piano_add_note:nn {0}{7.5,0.5}}
    {D1}{\__piano_add_note:nn {2}{8.5,0.5}}
    {E1}{\__piano_add_note:nn {4}{9.5,0.5}}
    {F1}{\__piano_add_note:nn {5}{10.5,0.5}}
    {G1}{\__piano_add_note:nn {7}{11.5,0.5}}
    {A1}{\__piano_add_note:nn {9}{12.5,0.5}}
    {B1}{\__piano_add_note:nn {$e$}{13.5,0.5}}
    {Ciss}{\__piano_add_note:nn {1}{1,\fp_eval:n {0.5+0.33*\l_piano_height_tl}}}
    {Diss}{\__piano_add_note:nn {3}{2,\fp_eval:n {0.5+0.33*\l_piano_height_tl}}}
    {Fiss}{\__piano_add_note:nn {6}{4,\fp_eval:n {0.5+0.33*\l_piano_height_tl}}}
    {Giss}{\__piano_add_note:nn {8}{5,\fp_eval:n {0.5+0.33*\l_piano_height_tl}}}
    {Aiss}{\__piano_add_note:nn {$t$}{6,\fp_eval:n {0.5+0.33*\l_piano_height_tl}}}
    {Ciss1}{\__piano_add_note:nn {1}{8,\fp_eval:n {0.5+0.33*\l_piano_height_tl}}}
    {Diss1}{\__piano_add_note:nn {3}{9,\fp_eval:n {0.5+0.33*\l_piano_height_tl}}}
    {Fiss1}{\__piano_add_note:nn {6}{11,\fp_eval:n {0.5+0.33*\l_piano_height_tl}}}
    {Giss1}{\__piano_add_note:nn {8}{12,\fp_eval:n {0.5+0.33*\l_piano_height_tl}}}
    {Aiss1}{\__piano_add_note:nn {$t$}{13,\fp_eval:n {0.5+0.33*\l_piano_height_tl}}}
   }
 }

\cs_generate_variant:Nn \str_case:nn { V }
\ExplSyntaxOff